# AWS Environment Configuration

This directory contains configuration for running Open-Claw-Fleet on AWS ECS.

## Structure

```
config/environments/aws/
├── config.yaml          # Agent definitions
└── README.md            # This guide
```

Generated artifacts (on EFS, at runtime):

```
/data/config/            # Synced from S3 (config/environments/aws)
/data/workspaces/        # Generated agent workspaces
/data/config/environments/aws/runtime/   # Runtime dir (currently unused by agent runtime)
```

**Templates:** Fleet Manager expects templates at `/data/config/templates`. Ensure `config/templates` is available there (for example, by syncing it to the config bucket or mounting it onto EFS).

## Usage

### Deploy Infrastructure First

Use the deployment script from the project root:

```bash
./scripts/deploy-aws-env.sh
```

### Get CDK Outputs

Use `outputs.json` generated by `./scripts/deploy-aws-env.sh` or view CloudFormation stack outputs in the AWS Console. Key outputs:

- `ClusterArn`
- `AgentTaskDefinitionArn`
- `PrivateSubnetIds`
- `AgentSecurityGroupId`
- `EfsFileSystemId`

### Run Fleet Manager

```bash
export AWS_REGION=us-east-1

# If running locally, set FLEET_SECRET (from Secrets Manager)
export FLEET_SECRET=your-secret-key

# Fleet manager auto-detects ECS orchestrator for 'aws' environment
fleet-manager start --env aws
```

## Configuration

Edit `config.yaml` to define your agents:

```yaml
ceo:
  name: Manu Mishra
  matrixId: "@manu.mishra:anycompany.corp"

matrix:
  homeserver: "http://conduit.anycompany.corp:6167"
  domain: "anycompany.corp"

agents:
  - name: Braxton Roberts
    department: Engineering
    level: VP
    title: VP of Engineering
```

## Storage

**EFS Structure:**
```
/data/workspaces/
  Engineering/
    braxton.roberts/
```

Each agent gets isolated directories on EFS for persistence (department + user slug).

## Secrets Management

### Fleet Secret

The fleet secret is automatically generated during CDK deployment:

Use `outputs.json` (or CloudFormation outputs in the AWS Console) to find `FleetSecretArn`.

### CEO Credentials

CEO credentials are automatically created by fleet manager on first run:

1. Fleet manager reads fleet secret from Secrets Manager
2. Derives CEO password: `HMAC-SHA256(fleet-secret, ceo-matrix-id)`
3. Stores CEO credentials in Secrets Manager
4. Registers CEO with Matrix server

### Agent Passwords

Agent passwords are derived from fleet secret:

```
password = HMAC-SHA256(fleet-secret, agent-matrix-id).slice(0, 32)
```

This ensures:
- Deterministic passwords (same agent always gets same password)
- No need to store per-agent passwords
- All passwords derived from one master secret

### Security

**Is this secure?** Yes - it's a standard cryptographic pattern.

**Why it's secure:**
1. **HMAC-SHA256 is cryptographically secure**
   - One-way function (can't reverse to get fleet secret)
   - Collision-resistant
   - Industry standard (JWT, OAuth, Bitcoin wallets)

2. **Fleet secret is protected**
   - Stored in AWS Secrets Manager (encrypted at rest)
   - Only accessible via IAM permissions
   - Never exposed in logs or code

3. **Derived passwords are strong**
   - 32 characters (256 bits of entropy)
   - Unique per agent (based on Matrix ID)
   - Can't derive other passwords from one password

4. **Attack scenarios**
   - Steal one agent password → ✅ Can't derive fleet secret or other passwords
   - Compromise container → ✅ Fleet secret only in memory, not on disk
   - Read CloudWatch logs → ✅ Secrets not logged
   - Steal EFS data → ✅ No passwords stored on EFS
   - Compromise Secrets Manager → ❌ Requires AWS account access

**Only 2 secrets total** (not 1 per agent):
- `openclaw/{env}/fleet-secret` - Master secret
- `openclaw/{env}/ceo` - CEO credentials

This avoids Secrets Manager limits (500,000 secrets/region) and reduces cost ($0.40/secret/month).

### Flow

```
1. CDK Deploy
   └─> Creates openclaw/{env}/fleet-secret (random)
   └─> Creates openclaw/{env}/ceo (placeholder)

2. Fleet Manager Start
   └─> Reads fleet secret from Secrets Manager
   └─> Derives CEO password
   └─> Updates openclaw/{env}/ceo with real credentials
   └─> Registers CEO with Matrix

3. Agent Start
   └─> Gets fleet secret from environment (injected by ECS)
   └─> Derives agent password
   └─> Registers/logs in with Matrix
```

| Variable | Description | Example |
|----------|-------------|---------|
| `ECS_CLUSTER_ARN` | ECS cluster ARN | `arn:aws:ecs:...` |
| `ECS_TASK_DEFINITION_ARN` | Agent task definition | `arn:aws:ecs:...` |
| `ECS_SUBNETS` | Private subnet IDs | `subnet-xxx,subnet-yyy` |
| `ECS_SECURITY_GROUPS` | Agent security group | `sg-xxx` |
| `EFS_FILE_SYSTEM_ID` | EFS file system | `fs-xxx` |
| `FLEET_SECRET_ARN` | Fleet secret ARN | `arn:aws:secretsmanager:...` |
| `CEO_SECRET_ARN` | CEO secret ARN | `arn:aws:secretsmanager:...` |
| `AWS_REGION` | AWS region | `us-east-1` |
