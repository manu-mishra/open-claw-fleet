FROM --platform=linux/arm64 node:20-alpine AS builder
WORKDIR /app
COPY packages/setup/agent-runtime/package*.json ./
RUN npm install --omit=dev

FROM --platform=linux/arm64 node:22
RUN apt-get update && apt-get install -y --no-install-recommends chromium patch && rm -rf /var/lib/apt/lists/*
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
ENV CHROME_BIN=/usr/bin/chromium
RUN npm install -g openclaw@latest && npm cache clean --force

# Fix Matrix plugin
RUN cd /usr/local/lib/node_modules/openclaw/extensions/matrix && \
    sed -i 's/"openclaw": "workspace:\*"/"openclaw": "*"/g' package.json && \
    npm install && npm rebuild

# Apply local patches to OpenClaw
COPY patches/openclaw-matrix /opt/patches/openclaw-matrix
RUN patch -p1 -d /usr/local/lib/node_modules/openclaw < /opt/patches/openclaw-matrix/disable-dm-threads.patch

# Install people plugin
COPY packages/plugins/people /opt/plugins/people
RUN cd /opt/plugins/people && npm install --production

WORKDIR /app
COPY --from=builder /app/node_modules ./node_modules
COPY packages/setup/agent-runtime ./
RUN mkdir -p /root/.openclaw
EXPOSE 8080
CMD ["node", "dist/index.js"]
