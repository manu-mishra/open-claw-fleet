FROM node:22
RUN apt-get update && apt-get install -y --no-install-recommends chromium patch && rm -rf /var/lib/apt/lists/*
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
ENV CHROME_BIN=/usr/bin/chromium
RUN npm install -g openclaw@latest && npm cache clean --force

# Fix Matrix plugin
RUN cd /usr/local/lib/node_modules/openclaw/extensions/matrix && \
    sed -i 's/"openclaw": "workspace:\*"/"openclaw": "*"/g' package.json && \
    npm install && npm rebuild

# Apply local patches to OpenClaw
COPY patches/openclaw-matrix /opt/patches/openclaw-matrix
RUN patch -p1 -d /usr/local/lib/node_modules/openclaw < /opt/patches/openclaw-matrix/disable-dm-threads.patch

# Install people plugin
COPY packages/plugins/people /opt/plugins/people
RUN cd /opt/plugins/people && npm install --production

# Install agent-runtime
COPY packages/setup/agent-runtime /opt/agent-runtime
RUN cd /opt/agent-runtime && npm install --production

RUN mkdir -p /root/.openclaw
ENV AWS_REGION=us-east-1
EXPOSE 20206

ENTRYPOINT ["node", "/opt/agent-runtime/dist/index.js"]
